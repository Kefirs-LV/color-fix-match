<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAL Color Picker</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
    background: #f5f5f5;
  }

  h2 {
    color: #333;
  }

  input[type="file"] {
    font-size: 18px;
  }

  #canvasContainer {
    position: relative;
    display: inline-block;
    margin-top: 20px;
  }

  canvas {
    max-width: 100%;
    border-radius: 10px;
    border: 1px solid #ccc;
  }

  #sampleCircle {
    position: absolute;
    border: 2px solid #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    pointer-events: none;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
  }

  #colorDisplay {
    margin-top: 15px;
    font-size: 20px;
    padding: 10px;
    background: #fff;
    border-radius: 12px;
    display: inline-block;
    min-width: 220px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  #colorBox {
    display: inline-block;
    width: 30px;
    height: 30px;
    vertical-align: middle;
    margin-right: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
</style>
</head>
<body>

<h2>RAL Color Picker</h2>

<input type="file" accept="image/*" id="photoInput">
<div id="canvasContainer">
    <canvas id="canvas"></canvas>
    <div id="sampleCircle"></div>
</div>
<div id="colorDisplay">
    <span id="colorBox"></span>
    HEX: <span id="hexCode">#FFFFFF</span> | RAL: <span id="ralCode">None</span>
</div>

<script>
// Load RAL colors
let ralColors = [];
fetch('ral.json')
  .then(response => response.json())
  .then(data => { ralColors = data; });

// Canvas setup
const photoInput = document.getElementById('photoInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const colorDisplay = document.getElementById('colorDisplay');
const colorBox = document.getElementById('colorBox');
const hexCodeEl = document.getElementById('hexCode');
const ralCodeEl = document.getElementById('ralCode');
const sampleCircle = document.getElementById('sampleCircle');

let img = new Image();

photoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const url = URL.createObjectURL(file);
    img.src = url;
});

img.onload = () => {
    canvas.width = img.width > 500 ? 500 : img.width;
    canvas.height = img.height * (canvas.width / img.width);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
};

// Sample radius in pixels
const SAMPLE_RADIUS = 8;

canvas.addEventListener('click', handlePick);
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    handlePick({clientX: touch.clientX, clientY: touch.clientY});
});

function handlePick(e){
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    // Move sample circle
    sampleCircle.style.left = `${x}px`;
    sampleCircle.style.top = `${y}px`;

    // Calculate average color
    const pixels = ctx.getImageData(
        Math.max(0,x-SAMPLE_RADIUS),
        Math.max(0,y-SAMPLE_RADIUS),
        Math.min(SAMPLE_RADIUS*2, canvas.width-x+SAMPLE_RADIUS),
        Math.min(SAMPLE_RADIUS*2, canvas.height-y+SAMPLE_RADIUS)
    ).data;

    let r=0, g=0, b=0, count=0;
    for(let i=0; i<pixels.length; i+=4){
        r += pixels[i];
        g += pixels[i+1];
        b += pixels[i+2];
        count++;
    }
    r = Math.round(r/count);
    g = Math.round(g/count);
    b = Math.round(b/count);

    const hex = rgbToHex(r,g,b);
    const ral = findClosestRAL(r,g,b);

    colorBox.style.background = hex;
    hexCodeEl.textContent = hex;
    ralCodeEl.textContent = ral;
}

function rgbToHex(r,g,b){
    return "#" + ((1<<24) + (r<<16) + (g<<8) + b).toString(16).slice(1).toUpperCase();
}

function findClosestRAL(r,g,b){
    if(ralColors.length===0) return "None";
    let minDist = Infinity;
    let closest = null;
    for(let color of ralColors){
        const dist = Math.sqrt((r-color.r)**2 + (g-color.g)**2 + (b-color.b)**2);
        if(dist < minDist){
            minDist = dist;
            closest = color.name;
        }
    }
    return closest;
}
</script>
</body>
</html>
